<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.262">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Implied Motion - 3&nbsp; Nifti to BIDS Conversion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./preprocessing.html" rel="next">
<link href="./dicom_2_nifti.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-title">Nifti to BIDS Conversion</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Implied Motion</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Computational Environments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dicom_2_nifti.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Dicom to Nifti Conversion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nifti_2_bids.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Nifti to BIDS Conversion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preprocessing.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Preprocessing MRI Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roi.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">ROI Extraction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./decode_within.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Decoding Within Category</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./decode_cross.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Cross Decoding</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./unused.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Unused</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./behavioural_data_notes.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Behavioural Data Notes</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#reorganise-the-nifti-files" id="toc-reorganise-the-nifti-files" class="nav-link active" data-scroll-target="#reorganise-the-nifti-files">Reorganise the Nifti Files</a></li>
  <li><a href="#create-events-files" id="toc-create-events-files" class="nav-link" data-scroll-target="#create-events-files">Create Events Files</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-title">Nifti to BIDS Conversion</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="reorganise-the-nifti-files" class="level2">
<h2 class="anchored" data-anchor-id="reorganise-the-nifti-files">Reorganise the Nifti Files</h2>
<p>At this point, the data is still messy. For a reusable and sharable format (and to be able to use it with some existing toolboxes), I rearranged the nifti data into the <a href="https://bids.neuroimaging.io/">BIDS</a> format. I tried to automate this process as much as possible, however the raw data was unstructured in different ways across participants in certain cases. Therefore, instead of writing 19 specialised versions of the code, I carried out some manual steps (e.g.&nbsp;moving structural scans from one folder to another). Running the code provided below on the raw data alone will not put the data into the BIDS format like you see it on the server.</p>
<p>The following example structure was created after taking the steps above.</p>
<pre><code>sub-01
│
└───func
│   │   sub-01_task-train_run-1_sbref.json
|   |   sub-01_task-train_run-1_sbref.nii
│   │   sub-01_task-train_run-1_bold.json
|   |   sub-01_task-train_run-1_bold.nii
|   |   ...
│   │   sub-01_task-test_run-16_sbref.json
|   |   sub-01_task-test_run-16_sbref.nii
│   │   sub-01_task-test_run-16_bold.json
|   |   sub-01_task-test_run-16_bold.nii
|
└───anat
|   │   sub-01_T1w.json
|   │   sub-01_T1w.nii
|
└───fmap
|   |   sub-01-magnitude1.json
|   |   sub-01-magnitude1.nii
|   |   sub-01-magnitude2.json
|   |   sub-01-magnitude2.nii
|   |   sub-01-phasediff.json
|   |   sub-01-phasediff.nii</code></pre>
<p><em>Extra Note</em>: Some participants have fieldmaps while others don’t. When available, I used them, and otherwise they are ignored</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb2"><pre class="sourceCode sourcecode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rename_nifti(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    project_root: <span class="bu">str</span>,  <span class="co"># root directory of the project</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    subject_no: <span class="bu">int</span>,  <span class="co"># subject no</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    bold_series_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">73.68783569335938</span>,  <span class="co"># size of bold series images</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    bold_ref_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.281585693359375</span>,  <span class="co"># size of bold reference images for some subjects</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    second_bold_ref_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">73.12533569335938</span>,  <span class="co"># size of bold reference images for some subjects</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    anat_ref_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">21.750335693359375</span>,  <span class="co"># size of anatomical images</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    fmap_ref_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.281585693359375</span>,  <span class="co"># size of fieldmap images</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""renames the files `dcm2niix` converted and puts them in bids format"""</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    subject_no <span class="op">=</span> <span class="bu">str</span>(subject_no)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># define boring references</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    allowed_sizes <span class="op">=</span> [</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        bold_series_size,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        bold_ref_size,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        anat_ref_size,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        fmap_ref_size,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        second_bold_ref_size,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    sub_folder <span class="op">=</span> <span class="ss">f"sub-</span><span class="sc">{</span>subject_no<span class="sc">.</span>zfill(<span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    nifti_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/bids"</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    all_imaging_data <span class="op">=</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create the following folders if they don't exist already</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    new_folders <span class="op">=</span> [</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/anat"</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/func"</span>,</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap"</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> folder <span class="kw">in</span> new_folders:</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            os.mkdir(folder)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">FileExistsError</span>:</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss"> already exists. Returning now..."</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">## rename anatomical image and the json</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    my_anat <span class="op">=</span> [</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_imaging_data</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.getsize(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>) <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> anat_ref_size</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    anat_image <span class="op">=</span> [</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_imaging_data</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.getsize(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>) <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> anat_ref_size</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    ][<span class="dv">0</span>].split(<span class="st">"."</span>)[<span class="dv">0</span>]</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    os.rename(</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>anat_image<span class="sc">}</span><span class="ss">.nii"</span>,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/anat/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">_T1w.nii"</span>,</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    os.rename(</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>anat_image<span class="sc">}</span><span class="ss">.json"</span>,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/anat/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">_T1w.json"</span>,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Organise things a bit and sorted behavioural file names based on date</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    beh_data <span class="op">=</span> os.listdir(</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/behavioural/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/"</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># get all files</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    beh_data <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> beh_data <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">".mat"</span>)]  <span class="co"># keep mat only</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    beh_data <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> beh_data <span class="cf">if</span> <span class="st">"ROILoc"</span> <span class="kw">not</span> <span class="kw">in</span> x]  <span class="co"># remove the localiser run</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    beh_date_dict <span class="op">=</span> {</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        re.search(<span class="vs">r"\d</span><span class="sc">{4}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">_\d</span><span class="sc">{2}</span><span class="vs">-\d</span><span class="sc">{2}</span><span class="vs">"</span>, x).group(): x <span class="cf">for</span> x <span class="kw">in</span> beh_data</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    }  <span class="co"># create a dict where dates are the keys &amp; file names are the values</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    beh_data_sorted <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>        beh_date_dict.keys(),</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        key<span class="op">=</span><span class="kw">lambda</span> x: datetime.datetime.strptime(x, <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">_%H-%M"</span>),</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># get the keys in sorted format</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    beh_data_sorted <span class="op">=</span> [</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        beh_date_dict[x] <span class="cf">for</span> x <span class="kw">in</span> beh_data_sorted</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    ]  <span class="co"># now get the file names in a sorted way</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now sort nifti and json files you want to keep based on number</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    nifti_data <span class="op">=</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    nifti_bold <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> nifti_data <span class="cf">if</span> (<span class="st">"bold"</span>) <span class="kw">in</span> x <span class="kw">and</span> (<span class="st">".nii"</span>) <span class="kw">in</span> x]</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    nifti_bold_json <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> nifti_data <span class="cf">if</span> (<span class="st">"bold"</span>) <span class="kw">in</span> x <span class="kw">and</span> (<span class="st">".json"</span>) <span class="kw">in</span> x]</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    nifti_bold_sorted <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>        nifti_bold, key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">int</span>(re.split(<span class="vs">r"(\d+)"</span>, x)[<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># split strings by numbers, take the second item from the last as the last item is the file extension</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    nifti_bold_json_sorted <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>        nifti_bold_json, key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">int</span>(re.split(<span class="vs">r"(\d+)"</span>, x)[<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># same as above but for json</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove nifti and json files if the corresponding nifti file is not</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># something we want (due to an interrupted run or the localisation block)</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    file_sizes <span class="op">=</span> [</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>        os.stat(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>).st_size <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> nifti_bold_sorted</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    ]  <span class="co"># get sorted file sizes (in MB)</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    illegal <span class="op">=</span> [file_sizes.index(x) <span class="cf">for</span> x <span class="kw">in</span> file_sizes <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> allowed_sizes]</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    illegal_refs <span class="op">=</span> [x <span class="op">-</span> <span class="dv">1</span> <span class="cf">for</span> x <span class="kw">in</span> illegal]  <span class="co"># reference images for the illegal images</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    illegal.extend(illegal_refs)</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    nifti_bold_sorted <span class="op">=</span> [</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>        nifti_bold_sorted[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(nifti_bold_sorted)) <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> illegal</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    nifti_bold_json_sorted <span class="op">=</span> [</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>        nifti_bold_json_sorted[i]</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(nifti_bold_json_sorted))</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> illegal</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now match between old names and new names you create below</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    bold_dict <span class="op">=</span> {x: [] <span class="cf">for</span> x <span class="kw">in</span> nifti_bold_sorted}</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    json_dict <span class="op">=</span> {x: [] <span class="cf">for</span> x <span class="kw">in</span> nifti_bold_json_sorted}</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    run <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    int_counter <span class="op">=</span> <span class="dv">0</span>  <span class="co"># every run is used twice in naming .nii files, one for reference the other for bold series. This is to keep track of that</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    mat_counter <span class="op">=</span> <span class="dv">0</span>  <span class="co"># need to keep seperate track of this as behavioural data file no does not match</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>    run_counter <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, <span class="bu">file</span> <span class="kw">in</span> <span class="bu">enumerate</span>(nifti_bold_sorted):</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> int_counter <span class="op">==</span> <span class="dv">2</span>:  <span class="co"># every two files</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>            int_counter <span class="op">=</span> <span class="dv">0</span>  <span class="co"># new behavioural file</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>            mat_counter <span class="op">+=</span> <span class="dv">1</span>  <span class="co"># new behavioural file</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>            run_counter <span class="op">+=</span> <span class="dv">1</span>  <span class="co"># increase run counts</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> int_counter:  <span class="co"># check type of block for new behavioral file</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"Train"</span> <span class="kw">in</span> beh_data_sorted[mat_counter]:</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>                block_type <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>                block_type <span class="op">=</span> <span class="st">"test"</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>        write_run <span class="op">=</span> run_counter</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>        image_type <span class="op">=</span> <span class="st">"sbref"</span> <span class="cf">if</span> int_counter <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"bold"</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>        int_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>        bold_dict[</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>        ] <span class="op">=</span> <span class="ss">f"sub-</span><span class="sc">{</span>subject_no<span class="sc">.</span>zfill(<span class="dv">2</span>)<span class="sc">}</span><span class="ss">_task-</span><span class="sc">{</span>block_type<span class="sc">}</span><span class="ss">_run-</span><span class="sc">{</span>write_run<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>image_type<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now assign the proper names with extensions both for jsons and nii images</span></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (key_bold, value), key_json <span class="kw">in</span> <span class="bu">zip</span>(bold_dict.items(), json_dict.keys()):</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>        bold_dict[key_bold] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">.nii"</span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>        json_dict[key_json] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">.json"</span></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now rename the func files</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cur_dict <span class="kw">in</span> [bold_dict, json_dict]:</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> cur_dict.items():</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>            os.rename(</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/func/</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add task name to json files</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> json_dict.values():</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>        side <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/func/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>        side[<span class="st">"TaskName"</span>] <span class="op">=</span> <span class="st">"test"</span> <span class="cf">if</span> <span class="st">"test"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="cf">else</span> <span class="st">"train"</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/func/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>, <span class="st">"w"</span>) <span class="im">as</span> to_write:</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>            json.dump(side, to_write)</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># move fieldmap to fmap folder</span></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>    e1_image <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_imaging_data <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">"e1.nii"</span>)]</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not all participants have fieldmaps</span></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># carry on with the following only if they have fieldmaps</span></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> e1_image:</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>        e1_image <span class="op">=</span> e1_image[<span class="dv">0</span>].split(<span class="st">"."</span>)[<span class="dv">0</span>]</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>        e2_image <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_imaging_data <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">"e2.nii"</span>)][</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>        ].split(<span class="st">"."</span>)[<span class="dv">0</span>]</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>        e2_ph_image <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_imaging_data <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">"e2_ph.nii"</span>)][</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>        ].split(<span class="st">"."</span>)[<span class="dv">0</span>]</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>        fmap_dict <span class="op">=</span> {</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>            e1_image: <span class="ss">f"</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">_magnitude1"</span>,</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>            e2_image: <span class="ss">f"</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">_magnitude2"</span>,</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>            e2_ph_image: <span class="ss">f"</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">_phasediff"</span>,</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> fmap_dict.items():</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>            os.rename(</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">.nii"</span>,</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap/</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">.nii"</span>,</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>            os.rename(</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">.json"</span>,</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap/</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">.json"</span>,</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add 'intended for' to fieldmaps</span></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>        fmap_files <span class="op">=</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap/"</span>)</span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>        func_files <span class="op">=</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/func/"</span>)</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>        func_files <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> func_files <span class="cf">if</span> <span class="st">"sbref"</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>        func_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> func_files <span class="cf">if</span> <span class="st">".nii"</span> <span class="kw">in</span> <span class="bu">file</span>]</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>        func_files <span class="op">=</span> [<span class="ss">f"func/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> func_files]</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> fmap_files:</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"json"</span> <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>                side <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>                side[<span class="st">"IntendedFor"</span>] <span class="op">=</span> func_files</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> <span class="bu">open</span>((<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/fmap/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>), <span class="st">"w"</span>) <span class="im">as</span> to_write:</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>                    json.dump(side, to_write)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>        os.rmdir(new_folders[<span class="dv">2</span>])</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove everything else</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/"</span>):</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>            os.remove(os.path.join(<span class="ss">f"</span><span class="sc">{</span>nifti_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>sub_folder<span class="sc">}</span><span class="ss">/"</span>, f))</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">IsADirectoryError</span>:</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>    par_list <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">4</span>, <span class="dv">24</span>))</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>    par_list.remove(<span class="dv">19</span>)  <span class="co"># the data from participant 19 is missing</span></span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>    home_dir <span class="op">=</span> Path.home()</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    project_dir <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>home_dir<span class="sc">}</span><span class="ss">/implied_motion"</span></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> participant <span class="kw">in</span> par_list:</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>        rename_nifti(project_root<span class="op">=</span>project_dir, subject_no<span class="op">=</span>participant)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="create-events-files" class="level2">
<h2 class="anchored" data-anchor-id="create-events-files">Create Events Files</h2>
<p>To create the event files used in my GLM, I used the following code below, which create one <code>.tsv</code> file per functional run and saves it under the relevant subject’s func folder in the <code>data/bids</code>. For the decoding, we tried two different kinds of design matrices. The examples for the two kind are:</p>
<p>If <code>expanded==False</code>, a table of the following type is created:</p>
<table class="table">
<thead>
<tr class="header">
<th>onset</th>
<th>duration</th>
<th>motion direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>15</td>
<td>left</td>
</tr>
<tr class="even">
<td>30</td>
<td>15</td>
<td>forward</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>If <code>expanded==True</code>, a table of this type is created:</p>
<table class="table">
<thead>
<tr class="header">
<th>onset</th>
<th>duration</th>
<th>motion direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>15</td>
<td>left_1</td>
</tr>
<tr class="even">
<td>30</td>
<td>15</td>
<td>forward_1</td>
</tr>
<tr class="odd">
<td>50</td>
<td>15</td>
<td>left_2</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb3"><pre class="sourceCode sourcecode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> namedtuple</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.io <span class="im">import</span> loadmat</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># I prepare two kinds of events files, expanded and compact, which are explained in `get_regressors`.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># These are saved under the `bids/&lt;&lt;SUBJECT&gt;&gt;/func` folder</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_regressors(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    project_root: <span class="bu">str</span>,  <span class="co"># root directory of the project</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    subj: <span class="bu">int</span>,  <span class="co"># subject no</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    expanded: <span class="bu">bool</span>,  <span class="co"># boolean value to determine whether to create expanded or compact regressor files</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    direction_coding: <span class="bu">dict</span> <span class="op">=</span> {</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: <span class="st">"forward"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span>: <span class="st">"backward"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="dv">3</span>: <span class="st">"right"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4</span>: <span class="st">"left"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    },  <span class="co"># how different directions are coded in the .mat files</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    n_dummies: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,  <span class="co"># number of dummy images</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    tr: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.2</span>,  <span class="co"># repetition time</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">    writes events files in bids compliant tsv format</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    sub_str <span class="op">=</span> <span class="ss">f"sub-</span><span class="sc">{</span><span class="bu">str</span>(subj)<span class="sc">.</span>zfill(<span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    file_dir <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/behavioural/</span><span class="sc">{</span>sub_str<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get files</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    all_files <span class="op">=</span> os.listdir(file_dir)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep the ones we are interested in (i.e. those that contain "Train" or "Test")</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    legal_files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> all_files <span class="cf">if</span> (<span class="st">"Train"</span> <span class="kw">in</span> <span class="bu">file</span>) <span class="kw">or</span> (<span class="st">"Test"</span> <span class="kw">in</span> <span class="bu">file</span>)]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sort them as regressors will be appended in a chronological order</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    legal_files.sort()</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># collect Row in rows to create a dataframe</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    Row <span class="op">=</span> namedtuple(<span class="st">"Row"</span>, [<span class="st">"onset"</span>, <span class="st">"duration"</span>, <span class="st">"trial_type"</span>])</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also get the associated run file names as the names will be used</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for tsv</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    run_files <span class="op">=</span> os.listdir(<span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/bids/</span><span class="sc">{</span>sub_str<span class="sc">}</span><span class="ss">/func/"</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    run_files <span class="op">=</span> <span class="bu">sorted</span>(run_files, key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">int</span>(re.split(<span class="vs">r"(\d+)"</span>, x)[<span class="op">-</span><span class="dv">2</span>]))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    run_files <span class="op">=</span> [x.split(<span class="st">"bold.nii"</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> run_files <span class="cf">if</span> <span class="st">"bold.nii"</span> <span class="kw">in</span> x]</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span>, img_file <span class="kw">in</span> <span class="bu">zip</span>(legal_files, run_files):</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        complete_path <span class="op">=</span> os.path.join(file_dir, <span class="bu">file</span>)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        mat <span class="op">=</span> loadmat(complete_path)[<span class="st">"logs"</span>][<span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># mat files have a funny format</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        motion_type <span class="op">=</span> <span class="st">"train"</span> <span class="cf">if</span> <span class="st">"Train"</span> <span class="kw">in</span> <span class="bu">file</span> <span class="cf">else</span> <span class="st">"test"</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> []</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># subtract is the starting point of scans, which is a nonzero value</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># it is used to set the first regressor at 0</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># note that it starts from the second block as the first block is to be discarded</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        subtract <span class="op">=</span> mat[<span class="st">"blockOnsets"</span>][<span class="dv">0</span>, <span class="dv">0</span>] <span class="op">-</span> n_dummies <span class="op">*</span> tr</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">=</span> {<span class="st">"forward"</span>: <span class="dv">1</span>, <span class="st">"backward"</span>: <span class="dv">1</span>, <span class="st">"left"</span>: <span class="dv">1</span>, <span class="st">"right"</span>: <span class="dv">1</span>}</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> <span class="bu">range</span>(mat[<span class="st">"blockOnsets"</span>].shape[<span class="dv">1</span>]):</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> block <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># don't record anything for the first block</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># get the direction from matching value to dictionary</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>                trial_type <span class="op">=</span> direction_coding[mat[<span class="st">"blockSeq"</span>][<span class="dv">0</span>, block]]</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> expanded:</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>                    trial_type_write <span class="op">=</span> (</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"</span><span class="sc">{</span>trial_type<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>counter[trial_type]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> motion_type <span class="op">==</span> <span class="st">"train"</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span> <span class="ss">f"</span><span class="sc">{</span>trial_type<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>counter[trial_type]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                    trial_type_write <span class="op">=</span> (</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"</span><span class="sc">{</span>trial_type<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> motion_type <span class="op">==</span> <span class="st">"train"</span> <span class="cf">else</span> <span class="ss">f"</span><span class="sc">{</span>trial_type<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                counter[trial_type] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>                <span class="co"># center onsets at 0 and add previous runs' times</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>                onset <span class="op">=</span> mat[<span class="st">"blockOnsets"</span>][<span class="dv">0</span>, block] <span class="op">-</span> subtract</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>                <span class="co"># the following is to accomodate for the slightly differently</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>                <span class="co"># coded structure fields in the .mat file</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> motion_type <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>                    duration <span class="op">=</span> (</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>                        mat[<span class="st">"blockOffsets"</span>][<span class="dv">0</span>, block] <span class="op">-</span> mat[<span class="st">"blockOnsets"</span>][<span class="dv">0</span>, block]</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                    duration <span class="op">=</span> mat[<span class="st">"bintOnset"</span>][<span class="dv">0</span>, block] <span class="op">-</span> mat[<span class="st">"blockOnsets"</span>][<span class="dv">0</span>, block]</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>                <span class="co"># for the df</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>                rows.append(</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>                    Row(</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>                        onset<span class="op">=</span>onset,</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>                        duration<span class="op">=</span>duration,</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>                        trial_type<span class="op">=</span>trial_type_write,</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expanded:</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>            write_path <span class="op">=</span> (</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/bids/</span><span class="sc">{</span>sub_str<span class="sc">}</span><span class="ss">/func/expanded_</span><span class="sc">{</span>img_file<span class="sc">}</span><span class="ss">events.tsv"</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>            write_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>project_root<span class="sc">}</span><span class="ss">/data/bids/</span><span class="sc">{</span>sub_str<span class="sc">}</span><span class="ss">/func/</span><span class="sc">{</span>img_file<span class="sc">}</span><span class="ss">events.tsv"</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        df.to_csv(write_path, index<span class="op">=</span><span class="va">False</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    par_list <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">4</span>, <span class="dv">24</span>))</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    par_list.remove(<span class="dv">19</span>)  <span class="co"># the data from participant 19 is missing</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    home_dir <span class="op">=</span> Path.home()</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    project_dir <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>home_dir<span class="sc">}</span><span class="ss">/implied_motion"</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> par <span class="kw">in</span> par_list:</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        get_regressors(project_root<span class="op">=</span>project_dir, subj<span class="op">=</span>par, expanded<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>        get_regressors(project_root<span class="op">=</span>project_dir, subj<span class="op">=</span>par, expanded<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./dicom_2_nifti.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Dicom to Nifti Conversion</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./preprocessing.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-title">Preprocessing MRI Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>